---
title: "Terraformã§ä½œã‚‹ã€GitHubã¨ArgoCDã‚’ç”¨ã„ãŸKubernetes(EKS)ã¸ã®CICD"
emoji: "ğŸŒ¸"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["kubernetes", "github", "cicd", "argocd", "eks"]
published: true
---

## æ¦‚è¦

Kubernetes (K8s) ã‚„ microservice ã‚’æœ€å¤§é™ã«æ´»ç”¨ã™ã‚‹ä¸Šã§ CICD åŸºç›¤ã¯æ¬ ã‹ã›ãªã„ã€‚  
æœ¬æ–‡æ›¸ã§ã¯ã€K8såŸºç›¤ã¨ã—ã¦[EKS][eks]ã‚’ã€CIã¨ã—ã¦[GitHub Actions][github-actions]ã‚’ã€CDã¨ã—ã¦[ArgoCD][argo-cd]ã‚’ã€IaCã¨ã—ã¦[Terraform][terraform]æ¡ç”¨ã—ãŸå ´åˆã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ä¾‹ã‚’è§£èª¬ã™ã‚‹ã€‚  
ç‰¹ã«ã€ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ã¸ã®æ‹¡å¼µã‚’æƒ³å®šã—ã€ä»¥ä¸‹è¦³ç‚¹ã‚’é‡è¦–ã—ã¦è¨­è¨ˆã™ã‚‹ã€‚

- çµ„ç¹”ã®æ‹¡å¤§ã«å¾“ã£ã¦ã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ãªã£ã¦ã„ã‚‹ã‹ã€‚ã™ãªã‚ã¡ã€äººãŒä»‹å…¥ã™ã‚‹ä½œæ¥­ã‚’æ¸›ã‚‰ã—ã€è‡ªå‹•åŒ–ã§ãã¦ã„ã‚‹ã‹
- å¯èƒ½ãªé™ã‚Šã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã¯å®£è¨€çš„ã«ä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹
  - Single Source of Truth ã‚’è¨­å®šã—ã€è¨­å®šãƒ»æ§‹æˆã‚’ä¸€ç®‡æ‰€ã«é›†ç´„ã™ã‚‹ãŸã‚
  - ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ‰ãƒªãƒ•ãƒˆã‚’æ¤œå‡ºã™ã‚‹ãŸã‚
- CICDåŸºç›¤ã®èªè¨¼èªå¯ã¯ã€çµ„ç¹”ã®æ¨©é™çµ±åˆ¶ã‚’åæ˜ ã—ã¦ã„ã‚‹ã‹

æœ¬æ–‡æ›¸ã§è¨˜è¿°ã™ã‚‹å†…å®¹ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

- GitHub Actionsã‚’ç”¨ã„ãŸCIã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ä¾‹
  - ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥
  - GitHub Organizationã‚’ç”¨ã„ãŸèªè¨¼ãƒ»èªå¯
  - GitHub Appsã‚’ç”¨ã„ãŸãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ãƒ»ä»–ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿
- ArgoCDã‚’ç”¨ã„ãŸCDã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ä¾‹
  - GitHub OAuth Appsã¨ã®èªè¨¼é€£æº
  - ArgoCD RBACã‚’ç”¨ã„ãŸèªå¯
  - ApplicationSetã‚’ç”¨ã„ãŸApplicationã®ä¸€æ‹¬ãƒ‡ãƒ—ãƒ­ã‚¤
- Terraformã‚’ç”¨ã„ãŸãƒªã‚½ãƒ¼ã‚¹ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
  - [GitHub provider][terraform-github-provider]ã‚’ç”¨ã„ãŸGitHubãƒªã‚½ãƒ¼ã‚¹ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
  - [AWS EKS module][terraform-eks-module]ã‚’ç”¨ã„ãŸEKSã‚¯ãƒ©ã‚¹ã‚¿ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
  - [Helm provider][terraform-helm-provider]ã‚’ç”¨ã„ãŸArgoCDã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    - ArgoCDã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šã®ç°¡ä¾¿ã•ã€Terraform providerã®åˆ©ç”¨ã—ã‚„ã™ã•ã‚’é‡è¦–ã—ã¦[ArgoCD Helm chart][argocd-helm]ã‚’æ¡ç”¨ã™ã‚‹[^argocd-helm]

æœ¬æ–‡æ›¸ã§ã¯ä¸»ã«è¨­è¨ˆæ€æƒ³ã‚„è¨­è¨ˆå†…å®¹ã‚’è§£èª¬ã™ã‚‹ã€‚æ§‹ç¯‰æ‰‹é †ã®è©³ç´°ãªè§£èª¬ã‚‚æ™‚é–“ãŒã‚ã‚Œã°æ›¸ããŸã„ã€‚  
ã‚³ãƒ¼ãƒ‰ç¾¤ã‚„ç°¡ç•¥æ‰‹ãªæ§‹ç¯‰æ‰‹é †ã¯ã€GitHub Organizationã‚‚å«ã‚ã¦GitHubã«å…¬é–‹ã—ã¦ã„ã‚‹[toyamagu-cicd]ã€‚  
è³ªå•ãƒ»æŒ‡æ‘˜ã‚’æ­“è¿ã—ã¾ã™ã€‚

## ã‚¤ãƒ³ãƒˆãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³

### èƒŒæ™¯

CICDã¯ä»¥ä¸‹è¦³ç‚¹ã‹ã‚‰ç¾åœ¨ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ãŠã„ã¦é‡è¦ãªã‚‚ã®ã¨ãªã£ã¦ã„ã‚‹

- ãƒ“ãƒ«ãƒ‰ãƒ»ãƒ†ã‚¹ãƒˆãƒ»ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ¥ãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è‡ªå‹•åŒ–ã—ãƒªãƒªãƒ¼ã‚¹ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’ã¯ã‚„ã‚ã‚‹
- ãƒ†ã‚¹ãƒˆã‚’è‡ªå‹•çš„ã«éƒ½åº¦è¡Œã†ã“ã¨ã§ã€å“è³ªã®æ”¹å–„ã‚’è¡Œã†
- è‡ªå‹•åŒ–ã‚’è¡Œã†ã“ã¨ã«ã‚ˆã£ã¦ã€ãƒ“ã‚¸ãƒã‚¹ã®æ‹¡å¤§ã«å¾“ã£ã¦ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¹ã‚±ãƒ¼ãƒ«ã™ã‚‹
  - ç‰¹ã«å¤§é‡ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹K8sç­‰ã®ã‚³ãƒ³ãƒ†ãƒŠã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¿ã‚’æ¡ç”¨ã™ã‚‹å ´åˆã€è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®ä»•çµ„ã¿ãŒãªã„ã¨äººçš„ã‚³ã‚¹ãƒˆãŒã‹ã‹ã‚‹

ãŸã ã—ã€CICDã¯ä»¥ä¸‹ã«æ³¨æ„ãŒå¿…è¦ã§ã‚ã‚‹

- ãƒ–ãƒ©ãƒ³ãƒãƒ»ãƒªãƒã‚¸ãƒˆãƒªæˆ¦ç•¥ã‚’å‰ã‚‚ã£ã¦å®šã‚ãªã„ã¨ã€ç¶­æŒå¹´æ•°ã®çµŒéã‚„åŸºç›¤æ‹¡å¤§ã«å¾“ã£ã¦åŸºç›¤ã‚’ç®¡ç†ã—ãã‚Œãªããªã‚Šã€é‹ç”¨ãŒå›°é›£ã«ãªã‚‹ã€‚
- CICDã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã‚½ãƒ¼ã‚¹ã¨ãªã‚‹GitHubã‚¤ãƒ™ãƒ³ãƒˆã«å¿œã˜ã¦ã€å®Ÿç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒè‡ªå‹•çš„ã«è¡Œã‚ã‚Œã‚‹
  - æ¨©é™çµ±åˆ¶ã®ä»•çµ„ã¿ã¥ãã‚Šã‚’ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«ã§è€ƒæ…®ã—ã¦ãŠã‹ãªã„ã¨ã€ãƒ‡ãƒ—ãƒ­ã‚¤äº‹æ•…ãƒ»ä¸æ­£ã«ç¹‹ãŒã‚‹

æœ¬æ–‡æ›¸ã§ã¯ä¸Šè¨˜ã‚’åŠ å‘³ã—ãŸä¸Šã§ã€è¨­è¨ˆãƒ»æ§‹ç¯‰ã‚’è¡Œã†ã€‚ç™»å ´ãƒªã‚½ãƒ¼ã‚¹ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

| ãƒªã‚½ãƒ¼ã‚¹            | èª¬æ˜                 |
| :------------------ | :------------------- |
| GitHub              | ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ç®¡ç†     |
| GitHub Organization | ãƒãƒ¼ãƒ ç®¡ç†           |
| GitHub Actions      | CI                   |
| ArgoCD              | CD                   |
| AWS                 | ã‚¯ãƒ©ã‚¦ãƒ‰             |
| EKS                 | Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ |

### äºˆå‚™çŸ¥è­˜

æœ¬æ–‡æ›¸ã‚’èª­ã‚€ä¸Šã§ã®äºˆå‚™çŸ¥è­˜ã‚’ç°¡å˜ã«ã¾ã¨ã‚ã‚‹ã€‚

- GitHub Apps
  - æœ¬æ–‡æ›¸ã®ç¯„å›²ã§ã¯ã€CICDã§ãƒªãƒã‚¸ãƒˆãƒªé–“ã®æ›¸ãè¾¼ã¿ã‚’è¡Œã†ãŸã‚ã®ã€ãƒã‚·ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã ã¨æ€ã£ã¦è‰¯ã„ã€‚
  - å˜ç´”ãªãƒã‚·ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨æ¯”è¼ƒã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ ã‚’å°‚æœ‰ã—ãªã„ãƒ»ä¸€æ™‚ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡ŒãŒæ¥½ãªã©å¤šãã®ãƒ¡ãƒªãƒƒãƒˆãŒæœ‰ã‚‹[[è§£èª¬][zenn-github-app]]ã€‚
  - è¨±å¯ã—ã¦ã„ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ä»¥ä¸‹ã®é€šã‚Šã€‚
    | ãƒªã‚½ãƒ¼ã‚¹     | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³     | èª¬æ˜                                        |
    | :----------- | :------------- | :------------------------------------------ |
    | Contents     | Read and Write | K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ãŸã‚           |
    | Pull Request | Read and Write | K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒªã§PRã‚’ç™ºè¡Œã™ã‚‹ãŸã‚ |
- [Kustomize][kustomize]
  - K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ç’°å¢ƒå·®åˆ†ç®¡ç†ã«ç”¨ã„ã‚‹
- ArgoCD
  - æœ¬æ–‡ä¸­ã§æ¦‚è¦ãƒ¬ãƒ™ãƒ«ã§è¨˜è¿°ã™ã‚‹
- NginxIngress
  - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã«ç”¨ã„ã‚‹

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®èª¬æ˜

æœ¬ç¯€ã§ã¯ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ§˜ã€…ãªè¦³ç‚¹ã‹ã‚‰èª¬æ˜ã™ã‚‹ã€‚

### CICDå…¨ä½“åƒ

æœ¬å°ç¯€ã§ã¯å…¨ä½“åƒã‚’è§£èª¬ã™ã‚‹ã€‚æœ¬ç¯€ã¯å…¨ä½“åƒã‚’èª¬æ˜ã™ã‚‹ã“ã¨ã«æ³¨åŠ›ã—ã€å®Ÿéš›ã«ã©ã®ã‚ˆã†ã«å®Ÿç¾ã™ã‚‹ã‹ã¯ã€å¾Œã®ç¯€ã§è©³ã—ãèª¬æ˜ã™ã‚‹ã€‚

ä»¥ä¸‹å›³ã«CICDã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å…¨ä½“åƒã‚’ç¤ºã™ã€‚

![cicd-overall-architecture](/images/cicd-eks-github-argocd/cicd-pipelinie.drawio.png)

ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

1. GitHub Organizationã‚’ä½œæˆã—ã€Organizationå†…éƒ¨ã«ä»¥ä¸‹ãƒªãƒã‚¸ãƒˆãƒªã‚’ä½œæˆã™ã‚‹ã€‚
    - `argocd-cicd-application`: K8sã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ç”¨ã®ãƒªãƒã‚¸ãƒˆãƒª
    - `argocd-k8s-manifest`: K8sã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã®K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆç”¨ã®ãƒªãƒã‚¸ãƒˆãƒª
    - `terraform-argocd-cicd`: ãƒªã‚½ãƒ¼ã‚¹ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ç”¨ã®Terraformã‚³ãƒ¼ãƒ‰ç”¨ã®ãƒªãƒã‚¸ãƒˆãƒª
1. `argocd-cicd-application` ã¯ãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã‚’ãƒˆãƒªã‚¬ãƒ¼ã¨ã—ã¦ä»¥ä¸‹ã®ã‚ˆã†ãªCICDã‚’è¡Œã†ã€‚
    - ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†
    - ã‚³ãƒ³ãƒ†ãƒŠãƒªãƒã‚¸ãƒˆãƒª (ECR) ã«ãƒ“ãƒ«ãƒ‰ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠã‚’publishã™ã‚‹
    - publishã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ãŸã‚ã«ã€ `argocd-cicd-k8s-manifest` ãƒªãƒã‚¸ãƒˆãƒªã®K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ›¸ãæ›ãˆã€CDãƒ„ãƒ¼ãƒ«ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’å§”ä»»ã™ã‚‹
      - æ›¸ãæ›ãˆå¯¾è±¡ã¯ä¸»ã«ã‚³ãƒ³ãƒ†ãƒŠã‚¿ã‚°ã§ã‚ã‚‹ã€‚CDãƒ„ãƒ¼ãƒ«ã«å¤‰æ›´ã‚’ä¼ãˆã‚‹ãŸã‚ã«ã€ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’ç”¨ã„ã¦ä¸Šæ›¸ãã™ã‚‹ã®ãŒä¸€èˆ¬çš„ã€‚
1. ArgoCDã¯ä»¥ä¸‹ã®ã‚ˆã†ãªCDã‚’è¡Œã†ã€‚
    - `argocd-cicd-k8s-manifest` ãƒªãƒã‚¸ãƒˆãƒªã‚’ç›£è¦–ã—ã€K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®å¤‰æ›´ã«å¿œã˜ã¦EKSã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†

å®Ÿéš›ã®é‹ç”¨ã®éš›ã¯ `argocd-cicd-k8s-manifest` ãƒªãƒã‚¸ãƒˆãƒªã§ã‚‚[Open Policy Agent][opa]ã‚„[Conftest][conftest]ç­‰ã‚’ç”¨ã„ãŸK8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ã‚³ãƒ³ãƒ—ãƒ©ã‚¤ã‚¢ãƒ³ã‚¹ãƒã‚§ãƒƒã‚¯ãªã©ã‚’è¡Œã†ã®ãŒè‰¯ã„ã ã‚ã†ã€‚  
ä»Šå›ã¯ã‚¹ã‚³ãƒ¼ãƒ—å¤–ã¨ã™ã‚‹ã€‚

ä»¥ä¸‹ã«æ³¨æ„ç‚¹ã‚’è¨˜è¿°ã™ã‚‹ã€‚

1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒªãƒã‚¸ãƒˆãƒªã¨ã€K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆç”¨ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’åˆ†ã‘ã‚‹ç†ç”±
    - é–‹ç™ºè€…ãƒ»é‹ç”¨è€…ã®èªçŸ¥è² è·ã‚’ä¸‹ã’ã‚‹ãŸã‚
    - è¤‡æ•°ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’ã¾ã¨ã‚ã‚‹ãŸã‚
    - ä¸è¦ãªCICDã®ãƒˆãƒªã‚¬ãƒ¼ã‚’é¿ã‘ã‚‹ãŸã‚
      - GitHubã‚¤ãƒ™ãƒ³ãƒˆã«å¿œã˜ã¦CICDã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹éš›ã€åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã ã¨ï¼ˆä½œã‚Šè¾¼ã¿ã‚’è¡Œã‚ãªã„é™ã‚Šï¼‰é–¢ä¿‚ãªã„ãƒªã‚½ãƒ¼ã‚¹ã®å¤‰æ›´ã«å¿œã˜ã¦CICDå…¨ä½“ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¦ã—ã¾ã†
      - æœ€æ‚ªã®å ´åˆç„¡é™ãƒ«ãƒ¼ãƒ—ã«é™¥ã‚‹
    - æ¨©é™çµ±åˆ¶ã®ãŸã‚
      - Gitãƒªãƒã‚¸ãƒˆãƒªã®æ¨©é™åˆ†å‰²ã¯ã€ãƒªãƒã‚¸ãƒˆãƒªå˜ä½ãƒ»ãƒ–ãƒ©ãƒ³ãƒå˜ä½ãŒã‚ã‚‹ã€‚GitHubãƒ»GitLabç­‰ã®ä¸»è¦ãªVCSã«ãŠã„ã¦ã€èªå¯ç”¨ã®ãƒ­ãƒ¼ãƒ«ã¯ãƒªãƒã‚¸ãƒˆãƒªå˜ä½ã§æŒ¯ã‚‰ã‚Œã‚‹
        - ãƒªãƒã‚¸ãƒˆãƒªå˜ä½ã§åˆ†ã‘ã‚‹ã¨é‹ç”¨è€…ãƒ»é–‹ç™ºè€…ã”ã¨ã«ãƒ­ãƒ¼ãƒ«ã‚’æŒ¯ã‚‹ã“ã¨ãŒã§ãã€èªå¯è¨­è¨ˆã—æ˜“ã„
      - CDãƒ„ãƒ¼ãƒ«ã®ã‚¢ã‚¯ã‚»ã‚¹å¯¾è±¡ã‚’åˆ†å‰²ã™ã‚‹ãŸã‚
    - ãã®ä»–ã€[ArgoCDã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹][argocd-best-practices]ã«è©³è¿°ã•ã‚Œã¦ã„ã‚‹ãŸã‚å‚ç…§

### GitHub

æœ¬å°èª¬ã§ã¯GitHubé–¢é€£ã®æƒ…å ±ã‚’è¨˜è¿°ã™ã‚‹ã€‚

#### ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥

æœ¬å°ç¯€ã§ã¯GitHubãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ã€ã¾ãŸCIã«é–¢é€£ã™ã‚‹GitHubã‚¤ãƒ™ãƒ³ãƒˆã‚’èª¬æ˜ã™ã‚‹ã€‚  

ãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ã‚’è¤‡é›‘ã«ã™ã‚Œã°æ¨©é™çµ±åˆ¶ã‚„ãƒªãƒªãƒ¼ã‚¹ç®¡ç†ã¯å³å¯†ã«ãªã‚‹ãŒã€ä¸€æ–¹ã§é‹ç”¨è² è·ãŒä¸Šæ˜‡ã™ã‚‹ã€‚å¤‰æ›´ã®å–ã‚Šè¾¼ã¿æ¼ã‚Œãªã©ã®ã€ãƒŸã‚¹ãŒç™ºç”Ÿã™ã‚‹ã‚‚ã¨ã«ã‚‚ãªã‚‹ã€‚  
ã“ã®ã‚ãŸã‚Šã®äº‹æƒ…ã¯[Git Flow][git-flow]ãƒ»[GitHub Flow][github-flow]ãƒ»[GitLab Flow][gitlab-flow]ãƒ»[Trunc base flow][trunc-base-flow]ãªã©ã®æœ‰åãªæˆ¦ç•¥ã‚’å­¦ã³ã€è‡ªèº«ã®ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã«åˆã£ãŸã‚‚ã®ã‚’æ¡ç”¨ã™ã‚‹ã®ãŒã‚ˆã„ã ã‚ã†ã€‚  
ãã‚Œãã‚Œã®æˆ¦ç•¥ã®æ¯”è¼ƒã¨ã—ã¦ã¯ã€GitLab Flowã®åºæ–‡ãŒã‚ã‹ã‚Šã™ã„ã€‚å€‹äººçš„ã«ã§ã¯ã‚ã‚‹ãŒã€å¤§ã¾ã‹ãªæŒ‡é‡ã¨ã—ã¦ã¯ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªæ–¹é‡ãŒã‚ã‚‹ã¨è€ƒãˆã¦ã„ã‚‹ã€‚

- ãƒªãƒªãƒ¼ã‚¹ã”ã¨ã«ãƒ‘ãƒƒãƒç­‰ã®é•·æœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå¿…è¦ã«ãªã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã‚‰ã€Git Flowãƒ™ãƒ¼ã‚¹ã®é‡åšãªãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹ã€‚
- ç‰¹ã«å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ãŒå¿…è¦ãªã„Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã‚‰ã€GitHub Flowãƒ™ãƒ¼ã‚¹ã®è»½é‡ãªãƒ–ãƒ©ãƒ³ãƒæˆ¦ç•¥ã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹ã€‚  

CICDã¨ã„ã†è¦³ç‚¹ã§ã¯GitLab Flowã‚’ãƒ™ãƒ¼ã‚¹ã«ã™ã‚‹ã®ãŒã‚ã‹ã‚Šã‚„ã™ã„ã¨æ€ã†ã®ã§ã€æœ¬æ–‡æ›¸ã§ã¯GitLab Flowã‚’ãƒ™ãƒ¼ã‚¹ã«é€²ã‚ã‚‹ã€‚
GitLab Flowã‚’ç°¡ç´ åŒ–ã—ãŸã‚‚ã®ã«ã€CIãƒ—ãƒ­ã‚»ã‚¹ã‚’åŠ ãˆãŸå›³ã‚’ä»¥ä¸‹ã«ç¤ºã™[^gitlab-flow]ã€‚

![git-branch](/images/cicd-eks-github-argocd/git-branch.drawio.png)

ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šã€‚

1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ãƒªãƒã‚¸ãƒˆãƒª (`argocd-cicd-application`)
    - å„ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã‚‹ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã‚’æ ¼ç´ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã‚’ç”¨æ„ã™ã‚‹ã€‚
      - å›³ã§ã¯ `main` (æœ¬ç•ªç’°å¢ƒ), `dev` (é–‹ç™ºç’°å¢ƒ)ã¨ã—ãŸã€‚
      - ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒã«å¯¾å¿œã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã¯ `main` ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸ãªã©ã«ã‚ˆã£ã¦ã‚‚æ¶ˆå»ã›ãšã€æ°¸ç¶šåŒ–ã™ã‚‹ã€‚
        - èª¤ã£ã¦æ¶ˆå»ã—ãªã„ã‚ˆã†ã€ãƒ–ãƒ©ãƒ³ãƒä¿è­·ãªã©ã‚’ç”¨ã„ã¦é©åˆ‡ã«ä¿è­·ã™ã‚‹ã€‚
    - æ©Ÿèƒ½å®Ÿè£…ç”¨ã®ä¸€æ™‚çš„ãªãƒ–ãƒ©ãƒ³ãƒã‚’ `feature/functionX` ã¨ä»®å®šã™ã‚‹ã€‚æ©Ÿèƒ½å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆå¾Œ `argocd-cicd-application`/`dev` ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸ã™ã‚‹ã€‚
      - Mergeå¾Œ `feature/functionX` ãƒ–ãƒ©ãƒ³ãƒã¯å‰Šé™¤ã™ã‚‹ã€‚
      - `argocd-cicd-application`/`dev` ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸ã«ã‚ˆã£ã¦CIãŒå‹•ä½œã™ã‚‹ã€‚
        - `argocd-cicd-k8s-manifest`/`dev` ãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã‚’è¡Œã†(å›³ã®ç·‘ç·š)[^k8s-manifest-push]ã€‚
      - `argocd-cicd-k8s-manifest`/`dev` ãƒ–ãƒ©ãƒ³ãƒã¯CDãƒ„ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ç›£è¦–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ é–‹ç™ºç’°å¢ƒã«æ–°è¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒè¡Œã‚ã‚Œã‚‹ã€‚
    - é–‹ç™ºç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆå¾Œæœ¬ç•ªç’°å¢ƒã«ãƒªãƒªãƒ¼ã‚¹ã™ã‚‹ãŸã‚ã€ `argocd-cicd-application`/`dev` ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ `argocd-cicd-application`/`main` ãƒ–ãƒ©ãƒ³ãƒã¸ã®PullRequestã‚’è¡Œã†ã€‚
      - ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€PullRequestã‚’Mergeã™ã‚‹ã€‚
      - `argocd-cicd-application`/`main` ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒãƒ¼ã‚¸ã«ã‚ˆã£ã¦CIãŒå‹•ä½œã™ã‚‹ã€‚
        - `argocd-cicd-k8s-manifest`/`dev` ãƒ–ãƒ©ãƒ³ãƒã‚’checkoutã™ã‚‹ã€‚`argocd-cicd-k8s-manifest`/`main` ãƒ–ãƒ©ãƒ³ãƒã¸ã®PRã‚’è¡Œã† (å›³ã®èµ¤ç·š) [^cicd-checkout-k8s-manifest]ã€‚
        - ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾ŒPRã‚’Mergeã™ã‚‹ã€‚
        - Mergeå¾Œä¸€æ™‚çš„ãªãƒ–ãƒ©ãƒ³ãƒã¯å‰Šé™¤ã™ã‚‹ã€‚
      - `argocd-cicd-k8s-manifest`/`main` ãƒ–ãƒ©ãƒ³ãƒã¯CDãƒ„ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ç›£è¦–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€ æœ¬ç•ªç’°å¢ƒã«æ–°è¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒè¡Œã‚ã‚Œã‚‹ã€‚
2. K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒª
    - å„ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ ¼ç´ã™ã‚‹ãƒ–ãƒ©ãƒ³ãƒã‚’ç”¨æ„ã™ã‚‹ã€‚ã“ã‚Œã‚‰ã¯æ°¸ç¶šåŒ–ã™ã‚‹ã€‚
      - å›³ã§ã¯ `main` (æœ¬ç•ªç’°å¢ƒ), `dev` (æœ¬ç•ªç’°å¢ƒä»¥å¤–)ã¨ã—ãŸã€‚
    - K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ç’°å¢ƒåˆ†ã‘ã¯ Kustomize ã‚’ç”¨ã„ã¦è¡Œã†ãŸã‚ã€ `dev` ãƒ–ãƒ©ãƒ³ãƒã«ã¯æœ¬ç•ªç’°å¢ƒä»¥å¤–ã®ã™ã¹ã¦ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’æ ¼ç´ã™ã‚‹[^kustomize-branch]ã€‚
    - å„ãƒ–ãƒ©ãƒ³ãƒã¯CDãƒ„ãƒ¼ãƒ«ã«ã‚ˆã£ã¦ç›£è¦–ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å„ãƒ–ãƒ©ãƒ³ãƒã¸ã®Push(Merge)ã¯å®Ÿç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã¤ãªãŒã‚‹ã€‚
    - Kustomizeã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¯ã€ä¾‹ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ã«ã™ã‚‹[^kustomize-directory]ã€‚

      ```console
      â”œâ”€â”€ base
      â”‚   â”œâ”€â”€ configMap.yaml
      â”‚   â”œâ”€â”€ deployment.yaml
      â”‚   â”œâ”€â”€ kustomization.yaml
      â”‚   â””â”€â”€ service.yaml
      â””â”€â”€ overlays
          â”œâ”€â”€ prd
          â”‚   â”œâ”€â”€ .env
          â”‚   â””â”€â”€ kustomization.yaml
          â””â”€â”€ dev
              â”œâ”€â”€ kustomization.yaml
              â””â”€â”€ .env
      ```

ä»¥ä¸‹ã«æ³¨æ„ç‚¹ã‚’è¨˜è¿°ã™ã‚‹ã€‚

1. ç’°å¢ƒå·®åˆ†ã®å¸åæ–¹é‡
    - é–‹ç™ºç’°å¢ƒãƒ»æœ¬ç•ªç’°å¢ƒã®ç’°å¢ƒå·®åˆ†ã¯ã€ConfigMapã‚„Secretãªã©ã®K8sæ©Ÿèƒ½ã‚’ç”¨ã„ã¦å¸åã™ã‚‹ã€‚
    - æ›è¨€ã™ã‚Œã°ã€K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒªã® `overlays/{prd|dev}/.env` ãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã§å¸åã™ã‚‹ã€‚
      - [12 factor app][12factor-app-config] (è‹¥å¹²å¤ã„ãŒ)ã«ã‚‚ã‚ã‚‹ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã§ã‚ã‚‹ ã€‚
    - *ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã§ãƒ–ãƒ©ãƒ³ãƒåˆ†å‰²ã—ã¦ã„ã‚‹ã‹ã‚‰ã¨ã—ã¦ãã¡ã‚‰ã§ç’°å¢ƒå·®åˆ†ã‚’å¸åã—ãªã„ã“ã¨*ã€‚
      - ç’°å¢ƒæ¯ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã«å·®åˆ†ãŒå­˜åœ¨ã™ã‚‹ã®ã¯ã€æ‚ªå¤¢ã§ã‚ã‚‹ã€‚
1. Kustomizeã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ãŒã€ç’°å¢ƒæ¯ã«Helm Chartã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„
    - Kustomizeã¯Helmã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹ã€‚`kustomize build` æ™‚ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã§ã€ArgoCDã®è¨­å®šã§æœ‰åŠ¹åŒ–ã™ã‚‹ã“ã¨ã€‚
1. ã‚³ãƒ³ãƒ†ãƒŠã‚¿ã‚°
    - CDãƒ„ãƒ¼ãƒ«ã¯ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®å·®åˆ†ã‚’æ¤œçŸ¥ã™ã‚‹ãŸã‚ã€ã‚³ãƒ³ãƒ†ãƒŠã‚¿ã‚°ã«ã¯å„ã‚³ãƒŸãƒƒãƒˆã§ä¸€æ„ãªã‚‚ã®ã‚’ç”¨ã„ã‚‹ã“ã¨
    - `latest` ãªã©ã¯å¤‰æ›´ãªã—ã¨ã¿ãªã•ã‚Œãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œãªã„
    - é–‹ç™ºç’°å¢ƒã§ã¯ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’åˆ©ç”¨ã™ã‚‹ã®ãŒæœ€ã‚‚ç°¡å˜ã§ã‚ã‚‹ãŸã‚ã€ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’ãã®ã¾ã¾ã‚¿ã‚°ã«åˆ©ç”¨ã™ã‚Œã°ã‚ˆã„ã ã‚ã†
    - æœ¬ç•ªç’°å¢ƒã§ã‚‚ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’ç”¨ã„ã‚‹ã®ã‚‚ä¸€ã¤ã®æ‰‹ã§ã‚ã‚‹æœ¬æ–‡æ›¸ä¸­ã§ã¯ç°¡å˜ã®ãŸã‚ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã«ã—ã¦ã‚ã‚‹
      - ãŸã ã—ã€CICDã®ãƒˆãƒªã‚¬ãƒ¼ã‚’mainãƒ–ãƒ©ãƒ³ãƒã¸ã®Mergeã‹ã‚‰Releaseã‚¿ã‚°ã®ç™ºè¡Œã«å¤‰æ›´ã—ã€ `vx.y.z` ãªã©ã‚’ã‚¿ã‚°ä»˜ã‘ã«åˆ©ç”¨ã™ã‚‹ã®ãŒä¸€ç•ªèªçŸ¥ä¸å¯ãŒä½ã„ã®ã§ã¯ãªã„ã‹ã¨è¨€ã†ã®ãŒå€‹äººçš„ãªè¦‹è§£ã§ã‚ã‚‹

#### CICD Secretç®¡ç†

æœ¬å°èª¬ã§ã¯CICD Secretç®¡ç†ã«ã¤ã„ã¦è¨˜è¿°ã™ã‚‹

GitHub Actionå®Ÿè¡Œæ™‚ã«ã‚‚è³‡æ ¼æƒ…å ±ãŒå¿…è¦ã«ãªã‚‹ã€‚ä¾‹ãˆã°ä»¥ä¸‹ã®ç”¨é€”ãŒã‚ã‚‹ã ã‚ã†ã€‚

- CIä¸­ã§ã®ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãƒ—ãƒƒã‚·ãƒ¥ã®ãŸã‚ã®ã€ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®èªè¨¼æƒ…å ±
- CIä¸­ã§ã®çµ±åˆãƒ†ã‚¹ãƒˆã®ãŸã‚ã«ã€ã‚¯ãƒ©ã‚¦ãƒ‰ã®èªè¨¼æƒ…å ±
- DBãƒ†ã‚¹ãƒˆã®ãŸã‚ã®ã€DBã®èªè¨¼æƒ…å ±

Secretã®ä¿å­˜å…ˆã¯ä»¥ä¸‹ã®2é€šã‚ŠãŒã‚ã‚‹ã€‚

1. Repository Secret
    - GitHubãƒªãƒã‚¸ãƒˆãƒªã«ç›´æ¥Secretã‚’ä¿ç®¡ã™ã‚‹
    - ç‰¹å®šãƒªãƒã‚¸ãƒˆãƒªã®ã¿ä½¿ç”¨ã™ã‚‹Secretæƒ…å ±ã¯ã“ã¡ã‚‰ã§è‰¯ã„ã€‚ãƒªãƒã‚¸ãƒˆãƒªã®ç®¡ç†è€…ã«Secretåˆ©ç”¨æ¨©é™ã‚’å§”ä»»ã—ãŸã„å ´åˆãªã©ã‚‚åˆ©ç”¨ã§ãã‚‹ã€‚
1. Organization Secret
    - GitHub Organizationã«Secretã‚’ä¿ç®¡ã—ã€ãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ã‚¿ãƒƒãƒã™ã‚‹
    - Organizationä¸­ã§å…±æœ‰ã™ã‚‹å ´åˆã«æœ‰ç”¨

æœ¬æ–‡æ›¸ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã¯ä»¥ä¸‹ã®èªè¨¼æƒ…å ±ãŒå¿…è¦ã§ã‚ã‚‹ã€‚å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã¯ [ã‚³ãƒ¼ãƒ‰ä¾‹](#CICDã‚³ãƒ¼ãƒ‰ä¾‹)å‚ç…§ã€‚

1. ECRãƒªãƒã‚¸ãƒˆãƒªã®èªè¨¼æƒ…å ±
    - AWSã®èªè¨¼æƒ…å ±
    - ä¸€æ™‚çš„ãªèªè¨¼æƒ…å ±ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€[GitHub OIDC][configuring-openid-connect-in-amazon-web-services]ã‚’ç”¨ã„ã‚‹
    - IAMãƒ­ãƒ¼ãƒ«ã®ARNã‚’Repository Secretã¨ã—ã¦ç™»éŒ²ã™ã‚‹
      - ç‰¹ã«ç§˜åŒ¿ã™ã‚‹å¿…è¦ã¯ãªã„ãŒã€å¤–éƒ¨ã‹ã‚‰å¤‰æ•°ã‚’ä¸ãˆã‚‹æ–¹æ³•ãŒSecretã—ã‹ãªã„ãŸã‚
1. K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒªã®ãŸã‚ã®èªè¨¼æƒ…å ±
    - GitHubã®èªè¨¼æƒ…å ±
    - ä¸€æ™‚çš„ãªèªè¨¼æƒ…å ±ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€GitHub Appsã‚’ç”¨ã„ã‚‹
    - Organizationå†…ã§å…±æœ‰ã™ã‚‹ãŸã‚ã€GitHub Appç§˜å¯†éµã‚’Organization Secretã¨ã—ã¦ç™»éŒ²ã™ã‚‹
### CICDã‚³ãƒ¼ãƒ‰ä¾‹

[toyamagu-cicd/argocd-cicd-application][toyamagu-cicd-argocd-cicd-application] ã«è¨­ç½®ã—ãŸã€‚
ã‚³ã‚¢ãªéƒ¨åˆ†ã¯ä»¥ä¸‹ã§ã‚ã‚‹ã€‚  

- AWS è³‡æ ¼æƒ…å ±å–å¾—
  - AWS IAM OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼æ©Ÿèƒ½ã‚’ç”¨ã„ã¦ã€[GitHub OpenID Connect][configuring-openid-connect-in-amazon-web-services] ã¨é€£æºã—ã¦ã„ã‚‹ãŸã‚ã€è³‡æ ¼æƒ…å ±ã®ç™ºè¡Œä¸è¦
  - [å‚è€ƒè¨˜äº‹][zenn-github-actions-support-openid-connect]


  ```yaml
  - name: Configure AWS credentials
    uses: aws-actions/configure-aws-credentials@v1-node16
    with:
      role-to-assume: ${{ secrets.IAM_ROLE_ARN }}
      aws-region: ${{ env.AWS_REGION }}
  ```

- GitHub App ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
  - K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿ã®ãŸã‚ã«ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã€‚

  ```yaml
  - name: Generate token
    id: generate-token
    uses: tibdex/github-app-token@v1
    with:
      app_id: ${{ secrets.APP_ID }}
      private_key: ${{ secrets[format('PEM_{0}', secrets.APP_ID)] }}
  ```

- Login ã¨ Build Image
  - ã‚¿ã‚°ã«ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥ã‚’æŒ‡å®š
  - ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã«ãƒ–ãƒ©ãƒ³ãƒåã‚’æŒ‡å®š
    - å‹¿è«–ã€å®Ÿéš›ã®é‹ç”¨ã§ã¯ECRãƒªãƒã‚¸ãƒˆãƒªã‚’åˆ†ã‘ã‚‹ã¹ãã ã—ã€ãã‚‚ãã‚‚ã€æœ¬ç•ªã¨é–‹ç™ºã®ECRãƒªãƒã‚¸ãƒˆãƒªã§AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆè‡ªä½“ã‚’åˆ†ã‘ã‚‹ã¹ãã ã‚ã†ã€‚

  ```yaml
  - name: Login to Amazon ECR
    id: login-ecr
    uses: aws-actions/amazon-ecr-login@v1

  - name: Build, tag, and push image to Amazon ECR
    id: build-image
    env:
      ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      working-dir: "."
    run: |
      TAG_PREFIX=$(echo ${{github.ref_name}} | sed 's/[\/#]/-/g')
      CONTAINER_REPO="${ECR_REGISTRY}/${{ env.ECR_REPOSITORY }}"
      CONTAINER_TAG="${TAG_PREFIX}-${{ github.sha }}"
      CONTAINER_NAME=${CONTAINER_REPO}:${CONTAINER_TAG}
      docker build -t ${CONTAINER_NAME} .
      docker push ${CONTAINER_NAME}
      echo "::set-output name=container-repo::${CONTAINER_REPO}"
      echo "::set-output name=container-tag::${CONTAINER_TAG}"
  ```

- Update K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ
  - `env.APPLICATION_DIR_PREFIX` ã§ãƒ‘ã‚¹ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒ‡å®š
  - `target-dir` ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ–ãƒ©ãƒ³ãƒã«å¿œã˜ã¦æ›¸ãæ›ãˆå…ˆã‚’æŒ‡å®š
    - `main` ãƒ–ãƒ©ãƒ³ãƒ -> `overlays/prd`
    - `dev` ãƒ–ãƒ©ãƒ³ãƒ -> `overlays/dev`

  ```yaml
  - name: Update K8s manifest
    env:
      CONTAINER_TAG: ${{needs.build-and-publish.outputs.container-tag}}
    run: |
      kustomize edit set image sample-app="*:${CONTAINER_TAG}"
    working-directory: "${{ env.APPLICATION_DIR_PREFIX }}/overlays/${{ steps.set-target-branch.outputs.target-dir }}"
  ```

- ãƒ–ãƒ©ãƒ³ãƒã«å¿œã˜ã¦K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒªã«pushã‹PR
  - `dev` -> K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒª/`dev` ãƒ–ãƒ©ãƒ³ãƒã«push
  - `main` -> K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒª/`dev` ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã€ K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒª/`main` ãƒ–ãƒ©ãƒ³ãƒã«PR

  ```yaml
  - name: Push
    if: ${{ steps.set-target-branch.outputs.target-branch == 'dev' }}
    run: |
      git push origin ${{ steps.set-target-branch.outputs.target-branch }}
  
  - name: Create Pull Request
    if: ${{ steps.set-target-branch.outputs.target-branch == 'main' }}
    id: cpr
    uses: peter-evans/create-pull-request@v4
    ...
  ```

### ArgoCD

æœ¬å°ç¯€ã§ã¯ArgoCDã«ã‚ˆã‚‹CDæ–¹æ³•ã‚’è¨˜è¿°ã™ã‚‹ã€‚

#### ArgoCDæ¦‚è¦

ArgoCDã¯GitOpsã«åŸºã¥ãK8sã‚¯ãƒ©ã‚¹ã‚¿ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†[CNCF Incubating Project][cncf-argocd]ã§ã‚ã‚‹ã€‚  
[GitHub][github-argocd]ã«ã‚³ãƒ¼ãƒ‰ãŒå…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã€‚  
ä»–ã®ãƒ¡ã‚¸ãƒ£ãƒ¼ãªCDãƒ„ãƒ¼ãƒ«ã®æ¯”è¼ƒã®æ¦‚è¦ã‚’ä»¥ä¸‹ã«ç¤ºã™ã€‚

- K8sä»¥å¤–ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«ã‚‚åˆ©ç”¨ã§ãã‚‹[Jenkins][jenkins] ã‚„ [Sppinaker][spinnaker] ã¨æ¯”è¼ƒã—ã¦ã€K8sã«ç‰¹åŒ–ã—ã¦ã„ã‚‹åˆ†ç°¡å˜ã«åˆ©ç”¨ã§ãã‚‹ã€‚
  - ä¸»è¦³ã ãŒã€GitOpsã®æ€æƒ³ã«ã‚‚ArgoCDã®ã»ã†ãŒã‚ˆã‚Šå¿ å®Ÿã§ã‚ã‚‹ã¨æ„Ÿã˜ã‚‹ã€‚
- K8sã«ç‰¹åŒ–ã—ãŸãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹FluxCDã‚ˆã‚Šã¯æ©Ÿèƒ½ãŒè±Šå¯Œ
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ãªã©
- [ArgoWorkflows][argo-workflows]ãƒ»[ArgoRollout][argo-rollout] ãªã©ã€å‘¨è¾ºãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã‚‚å„ªç§€ã€‚

ArgoCDã®åŸºæœ¬çš„ãªãƒªã‚½ãƒ¼ã‚¹ã¨æ¦‚è¦ã‚’ä»¥ä¸‹è¡¨ã«ç¤ºã™ã€‚è©³ç´°ã¯[å…¬å¼ãƒšãƒ¼ã‚¸][argocd]å‚ç…§ã®ã“ã¨ã€‚

| ãƒªã‚½ãƒ¼ã‚¹       | æ¦‚è¦                                                                                                                         |
| :------------- | :--------------------------------------------------------------------------------------------------------------------------- |
| Application    | GitOpså¯¾è±¡ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’æŒ‡å®šã™ã‚‹ArgoCD CRD                                                                                   |
| Project        | ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆæ™‚ã®æ¨©é™åˆ†å‰²ã«ç”¨ã„ã‚‹[^argocd-project]ã€‚Applicationã®ã¾ã¨ã¾ã‚Šã®æ¨©é™å¢ƒç•Œã¨ãªã‚‹                                   |
| ApplicationSet | Applicationã‚’TemplateåŒ–ã—ã€ä¸€æ‹¬ã§ç”Ÿæˆã™ã‚‹ã€‚ä¾‹ãˆã°ã€GitHubãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åˆè‡´ã™ã‚‹ãƒ‘ã‚¹ã®Appliactionã‚’ä¸€æ‹¬ä½œæˆã§ãã‚‹ |

å…¸å‹çš„ãª Application + Project ã®ã¿ã‚’åˆ©ç”¨ã—ãŸæ§‹æˆä¾‹ã‚’ä»¥ä¸‹å›³ã«ç¤ºã™ã€‚

![argocd-application](/images/cicd-eks-github-argocd/argocd-application.drawio.png)

ãƒã‚¤ãƒ³ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Š

- Project `prd` ã¯ `prd` NSã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¨±å¯ã•ã‚ŒãŸProjectã§ã‚ã‚‹ã€‚
- Application `sample-app` ã¯ä»¥ä¸‹ã«è¨­ç½®ã•ã‚ŒãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ (`kustomizaton.yaml) ã‚’ç¶™ç¶šçš„ã«ç›£è¦–ã—ã€å¤‰æ›´ã‚’åæ˜ ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚
  - ãƒªãƒã‚¸ãƒˆãƒª: `https://github.com/<user_name>/k8s-manifest-repo.git`
  - ãƒ‘ã‚¹: `application/sample-app/overlays/prd`
- ArgoCDã¯ã€ `kustomization.yaml` ã®å†…å®¹ã«å¿œã˜ã¦ã€EKSã‚¯ãƒ©ã‚¹ã‚¿ã« `Service` ã‚„ `Deployment` ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹

yamlã®ä¾‹ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

```yaml: application.yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: guestbook
  namespace: argocd
  finalizers:
    - resources-finalizer.argocd.argoproj.io
spec:
  project: prd

  source:
    repoURL: https://github.com/toyamagu-cicd/argocd-cicd-k8s-manifest.git  # Can point to either a Helm chart repo or a git repo.
    targetRevision: main  # For Helm, this refers to the chart version.
    path: application/sample-app/overlays/prd

  # Destination cluster and namespace to deploy the application
  destination:
    server: https://kubernetes.default.svc
    # The namespace will only be set for namespace-scoped resources that have not set a value for .metadata.namespace
    namespace: prd
```

ãã®ä»–GitHub WebHookã¨ã®é€£æºã‚„Slacké€šçŸ¥ãªã©ã€ãã“ãã“ç°¡å˜ã«ã§ãå®Ÿéš›ã®é‹ç”¨ã§ã¯é‡è¦ãªæ©Ÿèƒ½ã‚‚ã‚ã‚‹ãŒã€æœ¬ç­‹ã¨é–¢ä¿‚ãªã„ãŸã‚çœç•¥ã™ã‚‹ã€‚

#### ApplicationSetã‚’ç”¨ã„ãŸãƒªã‚½ãƒ¼ã‚¹ã®ä¸€æ‹¬ãƒ‡ãƒ—ãƒ­ã‚¤

ArgocdApplicationSet CRDã¯ã€Applicationã®templateã‚’ä¸€æ‹¬ã§ãƒ—ãƒ­ã‚¤ã™ã‚‹ä»•çµ„ã¿ã§ã‚ã‚‹[^argocd-applicationset-go-template]ã€‚  
å¾“æ¥ã€Applicationã®ä¸€æ‹¬ç®¡ç†ã¯App of Appsãƒ‘ã‚¿ãƒ¼ãƒ³ãªã©ãŒç”¨ã„ã‚‰ã‚Œã¦ããŸãŒã€ä»Šå›ã¯ApplicationSetã‚’åˆ©ç”¨ã™ã‚‹[^argocd-app-of-apps]ã€‚  
ArgoCD v2.3ã‹ã‚‰ArgoCD AppliactionSetã¯æ¨™æº–ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«åŒæ¢±ã•ã‚Œã¦ãŠã‚Šã€æ°—è»½ã«åˆ©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚  
ArgoCD ApplicationSetæ©Ÿèƒ½ã«ã¯ä»¥ä¸‹ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚‹ã€‚ArgoCDå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã® [monorepos][monorepos]ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ä¾‹ã‚‚å‚ç…§ã™ã‚‹ã¨è‰¯ã„ã€‚

- è¤‡æ•°ã®Applicationã‚’ä¸€æ‹¬ã§ãƒ—ãƒ­ã‚¤ã§ãã‚‹
  - ãƒãƒ«ãƒã‚¯ãƒ©ã‚¹ã‚¿ãƒ»ãƒãƒ«ãƒNSã‚’æŒ‡å®šå¯èƒ½
  - ã‚¯ãƒ©ã‚¹ã‚¿ã«bootstrapã§è¤‡æ•°ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã„ã¨ãã€æ‰‹é–“ãŒçœã‘ã‚‹[^argocd-applicationset-bootstrap]
  - Gitãƒªãƒã‚¸ãƒˆãƒªãƒ‘ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã‚’åˆ©ç”¨ã—ã¦ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ãƒãƒƒãƒã™ã‚‹è¤‡æ•°ã®ãƒ‘ã‚¹ã®Applicationã‚’ä¸€æ‹¬ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹
- å®£è¨€çš„ãªApplicationã®ä½œæˆã‚’å¼·åˆ¶ã§ãã‚‹
  - Applicationã®ç›´æ¥ã®ä½œæˆã‚’ç¦æ­¢ã—ã€Gitãƒªãƒã‚¸ãƒˆãƒªã«è¨­ç½®ã•ã‚ŒãŸãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã¨ã™ã‚‹
  - Gitãƒªãƒã‚¸ãƒˆãƒªã®Single source of truthã¨ã—ã¦ã®ä¿¡é ¼æ€§ãŒä¸Šæ˜‡ã™ã‚‹
- Templateã®ä¸€éƒ¨ã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã™ã‚‹ã“ã¨ã§ã€è¦ä»¶ã«å¿œã˜ãŸApplicationã®ä½œæˆãŒä¿è¨¼ã§ãã‚‹
  - ä¾‹ãˆã°ã€Proectã‚’ `dev` ã¨ã™ã‚‹ã“ã¨ã§ã€ä½œæˆã•ã‚Œã‚‹Applicationã®Projectã‚’ `dev` ã«åˆ¶é™ã§ãã‚‹

ä¸Šè¨˜ã«ã‚ˆã‚Šã€CDãƒ„ãƒ¼ãƒ«ã‚’æ¡ç”¨ã™ã‚‹ã“ã¨ã§ã®åˆ©ä¾¿æ€§ã‚’äº«å—ã—ã¤ã¤ã€æ¨©é™çµ±åˆ¶è¦ä»¶ã«å¿œã˜ãŸãƒªã‚½ãƒ¼ã‚¹ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå¯èƒ½ã«ãªã‚‹[^argocd-applicationset-git-generator]ã€‚  

å‰ç½®ããŒé•·ããªã£ãŸãŒã€ä»¥ä¸‹ã«ArgoCDã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³ã‚’ç¤ºã™ã€‚  

![argocd-applicationset](/images/cicd-eks-github-argocd/argocd-applicationset.drawio.png)

ApplicationSet `boostrap` ã®ã¿èª¬æ˜ã™ã‚Œã°æ®‹ã‚Šã®æ„å‘³ã‚‚æ´ã‚ã‚‹ã¨æ€ã†ã®ã§ã€ `bootstrap` ã®ã¿ã«çµã£ã¦è§£èª¬ã™ã‚‹ã€‚

- ç”¨é€”
  - ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã®boostrapã«å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ã‚’ä¸€æ‹¬ã§ãƒ—ãƒ­ã‚¤ã™ã‚‹
  - ä»Šå›ã®ä¾‹ã§ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ç”¨ã®[NginxIngress][ingress-nginx]ã‚’å¯¾è±¡ã¨ã—ã¦ã„ã‚‹ã€‚
- Gitãƒªãƒã‚¸ãƒˆãƒªç›£è¦–å¯¾è±¡
  - ãƒªãƒã‚¸ãƒˆãƒª: [toyamagu-cicd/argocd-cicd-k8s-manifest][toyamagu-cicd-argocd-cicd-k8s-manifest]
  - `main` ãƒ–ãƒ©ãƒ³ãƒ
    - Bootrapã«ç”¨ã„ã‚‹é‡è¦ãªã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã€é‹ç”¨ç®¡ç†è€…ãŒä½œæˆã™ã‚‹å‰æã¨ã™ã‚‹ã€‚å¾Œã®æ¨©é™çµ±åˆ¶ã‚‚å‚ç…§ã€‚
  - `application/bootstrap/*` ãƒ‘ã‚¹
    - `application/bootstrap/nginx-ingress`
      - [URL][github-k8s-manifest-nginx-ingress]
      - NginxIngress Helm chartã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
    - `application/bootstrap/virtual-server`
      - [URL][github-k8s-manifest-virtual-server]
      - NginxIngress CRDã® VirtualServer ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
- ä½œæˆã•ã‚Œã‚‹Application
  - Templateæ©Ÿèƒ½ `{{path.basename}}` ã‚’åˆ©ç”¨ã—ã¦ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªåã‚’ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã¨ã™ã‚‹
    - `nginx-ingress`
    - `virtual-server`

ä¸Šè¨˜ã®ApplicationãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã“ã¨ã«ã‚ˆã‚Šã€boostrapã«å¿…è¦ãªK8sãƒªã‚½ãƒ¼ã‚¹ãŒä¸€æ‹¬ã§ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã“ã¨ã«ãªã‚‹ã€‚  
ä»Šå›ã®å ´åˆã¯ã€ApplicationSetã‚’Terraformä¸­ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã“ã¨ã«ã‚ˆã‚Šã€EKSã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨åŒæ™‚ã«ArgoCDã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ãŒå¯èƒ½ã«ãªã£ã¦ã„ã‚‹ã€‚  
è©³ç´°ã¯Terraformã‚»ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ã€‚

yamlã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹ã€‚

```yaml: applicationset.yaml
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: bootstrap
  namespace: argocd
spec:
  generators:
  - git:
      repoURL: https://github.com/toyamagu-cicd/argocd-cicd-k8s-manifest.git
      revision: main
      directories:
      - path: "application/*/overlays/prd"
  template:
    metadata:
      name: '{{path.basename}}'
    spec:
      project: bootstrap
      source:
        repoURL: https://github.com/toyamagu-cicd/argocd-cicd-k8s-manifest.git
        targetRevision: main
        path: '{{path}}'
      destination:
        server: https://kubernetes.default.svc
        namespace: '{{path.basename}}'
```


#### K8s Secretç®¡ç†

CICDã‚’è¡Œã†å ´åˆã€K8s Secretç®¡ç†ã¯åˆ‡ã‚Šé›¢ã›ãªã„é–¢ä¿‚ã«ã‚ã‚‹ãŸã‚ã€ã“ã®ç¯€ã§ç°¡å˜ã«è¨€åŠã—ã¦ãŠãã€‚  
å®Ÿéš›ã€ArgoCDã‚’é‹ç”¨ã™ã‚‹ãŸã‚ã«ã‚‚ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆGitãƒªãƒã‚¸ãƒˆãƒªã®è³‡æ ¼æƒ…å ±ã‚„ã€OAuthç”¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãªã©ãŒå¿…è¦ã§ã‚ã‚‹ã€‚

GitOpsã¯å…¨ã¦ã®æƒ…å ±ãŒGitãƒªãƒã‚¸ãƒˆãƒªã«æ ¼ç´ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç†æƒ³ã¨ã™ã‚‹ãŒã€å‹¿è«–è³‡æ ¼æƒ…å ±ãªã©ã‚’Gitãƒªãƒã‚¸ãƒˆãƒªã«æ ¼ç´ã—ã¦ã¯ã„ã‘ãªã„ã€‚  
[sealed-secrets][sealed-secrets]ãªã©ã‚’ç”¨ã„ã¦æš—å·åŒ–ã—ãŸä¸Šã§Gitãƒªãƒã‚¸ãƒˆãƒªã«æ ¼ç´ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã ãŒã€éµã‚’ç”¨æ„ã—ã¦éƒ½åº¦æš—å·åŒ–ã—ãªã„ã¨ã„ã‘ãªã„ãŸã‚æ‰‹é–“ãŒå¢—ãˆã€ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³äº‹æ•…ãªã©ãŒæ€–ã„ã€‚  
ãã®ãŸã‚ã€å„ã‚¯ãƒ©ã‚¦ãƒ‰ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚„ã€[HashiCorp Vault][vault]ã®å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ç”¨ã„ã‚‹ã®ãŒã¨ã£ã¤ãã‚„ã™ã„ã¨æ€ã‚ã‚Œã‚‹ã€‚  
æœ¬æ–‡æ›¸ã§ã¯ AWS SystemsManager ParameterStoreã«è³‡æ ¼æƒ…å ±ã‚’æ ¼ç´ã™ã‚‹ã“ã¨ã«ã™ã‚‹ã€‚  
AWS SecretsManagerã‚’åˆ©ç”¨ã—ãªã„ã®ã¯ã€æ–™é‡‘ãŒã‹ã‹ã‚‹ã®ã¨ã€æ¶ˆå»ã™ã‚‹ã®ãŒè‹¥å¹²é¢å€’ã ã‹ã‚‰ã§ã‚ã‚‹ã€‚  
æœ¬ç•ªé‹ç”¨ã§ã¯AWS SecretsManagerã®æ–¹ãŒæ©Ÿèƒ½é¢ã§å„ªã‚Œã¦ã„ã‚‹ã®ã§ã€ãã¡ã‚‰ã‚’å„ªå…ˆã™ã‚‹ã¨ã‚ˆã„ã ã‚ã†ã€‚  

å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿ç®¡ã—ãŸè³‡æ ¼æƒ…å ±ã¯ã€ã©ã®ã‚ˆã†ã«K8sä¸Šã«ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚Œã°è‰¯ã„ã®ã ã‚ã†ã‹ã€‚ã“ã‚Œã‚‚ã„ãã¤ã‹é¸æŠè‚¢ãŒã‚ã‚‹ã€‚

- [External Secrets Operator][external-secrets]
  - å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰K8s Secretsã‚’ä½œæˆã§ãã‚‹
- [Secrets Store CSI Driver][secrets-store-csi-driver]
  - å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰K8s Secretã‚’ä½œæˆã§ãã‚‹ã€‚ã“ã¡ã‚‰ã¯Podã«ãƒã‚¦ãƒ³ãƒˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
  - ã—ãŸãŒã£ã¦ã€SecretãŒä½œæˆã•ã‚Œã‚‹ãŸã‚ã«ã¯Podã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
- [Terraform kubernetes provider][terraform-kubernetes-provider]
  - Terraformã®dataã§å¤–éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’æ‹¾ã£ã¦ãã¦K8s providerã‚’ç”¨ã„ã¦Secretã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚
  - K8sã‚¯ãƒ©ã‚¹ã‚¿ã«è¿½åŠ ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãªãã¦è‰¯ã„ãŒã€`.tfstate` ã«ãƒ‡ãƒ¼ã‚¿ãŒæ®‹ã£ã¦ã—ã¾ã†ã®ãŒé›£ç‚¹ã€‚

å€‹äººçš„ã«ã¯ã€Podã«è³‡æ ¼æƒ…å ±ã‚’ãƒã‚¦ãƒ³ãƒˆã™ã‚‹å‰æãªã‚‰ã€SecretsStoreã‚’ç”¨ã„ã‚‹ã¨æ¥½ã§ã‚ã‚‹ã¨è€ƒãˆã‚‹ã€‚  
[AWSã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][secrets-store-csi-driver-aws]ã‚‚å……å®Ÿã—ã¦ã„ã‚‹ã€‚  
æœ¬æ–‡æ›¸ã§ã¯è¿½åŠ ã®ãƒªã‚½ãƒ¼ã‚¹ãŒå¿…è¦ãªã„ã¨ã„ã†ç°¡ä¾¿ã•ã‚’é‡è¦–ã—ã¦Terraformã§Secretsã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹ã€‚*æ¨å¥¨ã¯ã—ãªã„*ã€‚  
SecretsStoreã«æ‹¡å¼µã™ã‚‹ã®ã¯å®¹æ˜“ã§ã‚ã‚‹ã€‚
ã•ã‚‰ãªã‚‹è©³ç´°ã¯Terraformã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è­²ã‚‹ã€‚

#### Helm Chartåˆ©ç”¨æ–¹æ³•

ArgoCDã‚‚å«ã‚€Argoãƒ•ã‚¡ãƒŸãƒªãƒ¼ã«ã¯å…¬å¼ã®Helm chartãŒãªã„ãŒã€[Community maintainedãªHelm chartãŒå­˜åœ¨ã—][argo-helm]ã€ç¾åœ¨ã‚‚æ´»ç™ºã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã•ã‚Œã¦ã„ã‚‹ã€‚  
ã“ã® `argo-cd` Helm chartã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã«ãªã‚‹ã€‚  

ä¸Šè¨˜ã«åŠ ãˆã¦ã€ `argocd-apps` Helm chartãŒã‚ã‚‹[^argocd-apps]ã€‚  
ã“ã®Helm chartã§ã¯ã€Applicationãƒ»Projectãƒ»ApplicationSetãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã‚‹ã€‚  

ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ä½œæˆã¨åŒæ™‚ã«ArgoCDã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚„ã€ApplicationSetã€Projectã®ä½œæˆã¾ã§çµ‚ã‚ã£ã¦ã„ã‚‹ã¨æ‰‹ä½œæ¥­ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹æ‰‹é–“ãŒçœã‘ã‚‹ã€‚
ãã“ã§ã€æœ¬æ–‡æ›¸ã§ã¯[Terraform helm provider][terraform-helm-provider]ã‚’ç”¨ã„ã¦Terraformä¸­ã§ä¸Šè¨˜Helm chartã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œã£ã¦ã„ã‚‹ã€‚

### æ¨©é™çµ±åˆ¶

æœ¬å°ç¯€ã§ã¯æ¨©é™çµ±åˆ¶æ–¹æ³•ã‚’èª¬æ˜ã™ã‚‹ã€‚  

å‰è¿°ã®é€šã‚Šã€CICDåŸºç›¤ã§ã¯ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«ã§ã®æ¨©é™çµ±åˆ¶ãŒé‡è¦ã§ã‚ã‚‹[^governance]ã€‚  
å³ã—ã™ãã‚‹æ¨©é™çµ±åˆ¶ã¯é–‹ç™ºåŠ¹ç‡ã‚’è½ã¨ã™ä¸€æ–¹ã§ã€ç·©ã™ãã‚‹æ¨©é™çµ±åˆ¶ã¯ä¸æ­£ãƒ‡ãƒ—ãƒ­ã‚¤ãªã©ã®ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆã«ç›´çµã™ã‚‹ã€‚
ä¸¡æ¥µé™ã‚’åŠ å‘³ã—ãŸä¸Šã§ã€é–‹ç™ºè€…ãƒ»é‹ç”¨è€…åŒæ–¹ãŒæ¨©é™çµ±åˆ¶ã®æ„ç¾©ã‚’ç†è§£ã—ã€åˆæ„ã—ãŸä¸Šã§é©åˆ‡ãªæ¨©é™çµ±åˆ¶ã‚’è¨­å®šã™ã‚‹ã“ã¨ã€‚

ä»¥ä¸‹å›³ã«æœ¬æ–‡æ›¸ã§ã®æ¨©é™çµ±åˆ¶ã®æ¦‚å¿µå›³ã‚’ç¤ºã™ã€‚  
[ArgoCD Dex][argocd-user-management]ã‚’ç”¨ã„ã¦GitHubã¨ã®OAuthé€£æºã‚’è¡Œã†ãŸã‚ã€GitHubã§ã®èªè¨¼ãƒ»èªå¯ã¯ArgoCDã®èªè¨¼ãƒ»èªå¯ã¨é–¢é€£ã™ã‚‹ã€‚

![cicd-authorization](/images/cicd-eks-github-argocd/cicd-authorization.drawio.png)

ä»¥ä¸‹GitHubãƒªãƒã‚¸ãƒˆãƒªãƒ»ArgoCDãã‚Œãã‚Œã«å¯¾ã—ã¦è©³ã—ã„èª¬æ˜ã‚’ã™ã‚‹ãŒã€è¨­å®šæ–¹é‡ã®æ¦‚ç•¥ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã‚ã‚‹ã€‚

- æœ¬ç•ªç’°å¢ƒãƒ»é–‹ç™ºç’°å¢ƒã¨ã‚‚ã«é–‹ç™ºè€…ãƒ»é‹ç”¨è€…ã«å…¨ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹èª­ã¿å–ã‚Šæ¨©é™ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã€‚
- æœ¬ç•ªç’°å¢ƒ `prd` NSã¯é‹ç”¨è€…ã®ã¿ãŒãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™ã‚’æŒã¤ã“ã¨
- é–‹ç™ºç’°å¢ƒ `dev` NSã¯é–‹ç™ºè€…ãƒ»é‹ç”¨è€…ãŒãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™ã‚’æŒã¤ã“ã¨

#### GitHubãƒªãƒã‚¸ãƒˆãƒª

GitHubãƒªãƒã‚¸ãƒˆãƒªã«å¯¾ã™ã‚‹ãƒ­ãƒ¼ãƒ«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®šã‚ã‚‹ã€‚
GitHubã®ãƒ–ãƒ©ãƒ³ãƒä¿è­·è¨­å®š `Restrict who can push to matching branches` ã§ã€Mergeå¯èƒ½ãªã‚¢ã‚¯ã‚¿ãƒ¼ã‚’åˆ¶é™ã§ãã‚‹ã€‚

- ãƒ­ãƒ¼ãƒ«ã‚’Maintainã®ã¿ã«åˆ¶é™
- (Teamä»¥ä¸Š) Organizationã®ç‰¹å®šã‚°ãƒ«ãƒ¼ãƒ—ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã«åˆ¶é™
- (Teamä»¥ä¸Š) ç‰¹å®šã®GitHub Appã«åˆ¶é™

ã“ã‚Œã‚’åˆ©ç”¨ã—ã¦ã€æœ¬ç•ªç’°å¢ƒãƒ–ãƒ©ãƒ³ãƒã¸ã®Mergeã‚’çµ±åˆ¶ã™ã‚‹ [^github-organization-free] ã€‚

| ãƒªãƒã‚¸ãƒˆãƒª                 | ãƒ–ãƒ©ãƒ³ãƒ | å½¹å‰²                                                  | Mergeå¯èƒ½ãªãƒ­ãƒ¼ãƒ« |
| :------------------------- | :------- | :---------------------------------------------------- | :---------------- |
| ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒã‚¸ãƒˆãƒª | `main`   | æœ¬ç•ªç’°å¢ƒã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ãŒæ ¼ç´ã•ã‚Œã‚‹ã€‚          | Maintain          |
|                            | `dev`    | é–‹ç™ºç’°å¢ƒã«ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰ãŒæ ¼ç´ã•ã‚Œã‚‹ã€‚          | Write             |
| K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒª  | `main`   | æœ¬ç•ªç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãŒæ ¼ç´ã•ã‚Œã‚‹ã€‚ | Maintain          |
|                            | `dev`    | é–‹ç™ºç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãŒæ ¼ç´ã•ã‚Œã‚‹ã€‚ | Write             |

GitHubãƒªãƒã‚¸ãƒˆãƒªã§ã®ã‚¢ã‚¯ã‚¿ãƒ¼ãƒ»ãƒ­ãƒ¼ãƒ«ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«å®šã‚ã‚‹ã€‚GitHub Appã ã‘ã¯ç‰¹æ®Šã ãŒã€æœ¬æ–‡æ›¸ã®è¨­å®šã ã¨å¤§ä½“Writeã¨åŒã˜ã€‚

| ã‚¢ã‚¯ã‚¿ãƒ¼         | ãƒªãƒã‚¸ãƒˆãƒª                 | ãƒ­ãƒ¼ãƒ«   | èª¬æ˜ãƒ»ç†ç”±                                                                 |
| :--------------- | :------------------------- | :------- | :------------------------------------------------------------------- |
| Developer        | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒã‚¸ãƒˆãƒª | Write    | é–‹ç™ºç’°å¢ƒãƒ–ãƒ©ãƒ³ãƒã¸ã® `push` ã‚„ã€æœ¬ç•ªç’°å¢ƒãƒ–ãƒ©ãƒ³ãƒã¸ã® PR ã‚’è¡Œã†ãŸã‚ã€‚ |
| Developer leader | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒã‚¸ãƒˆãƒª | Maintain | æœ¬ç•ªç’°å¢ƒãƒ–ãƒ©ãƒ³ãƒã®PRã‚’æ‰¿èªã™ã‚‹ãŸã‚ã€‚                                 |
| Operator         | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒã‚¸ãƒˆãƒª | Maintain | æœ¬ç•ªç’°å¢ƒãƒ–ãƒ©ãƒ³ãƒã®PRã‚’æ‰¿èªã™ã‚‹ãŸã‚ã€‚                                 |
| Developer        | K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒª  | Write    | é–‹ç™ºç’°å¢ƒãƒ–ãƒ©ãƒ³ãƒã¸ã® `push` ã‚„ã€æœ¬ç•ªç’°å¢ƒãƒ–ãƒ©ãƒ³ãƒã¸ã® PR ã‚’è¡Œã†ãŸã‚ã€‚ |
| Developer leader | K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒª  | Write    | é–‹ç™ºç’°å¢ƒãƒ–ãƒ©ãƒ³ãƒã¸ã® `push` ã‚„ã€æœ¬ç•ªç’°å¢ƒãƒ–ãƒ©ãƒ³ãƒã¸ã® PR ã‚’è¡Œã†ãŸã‚ã€‚ |
| Operator         | K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒª  | Maintain | æœ¬ç•ªç’°å¢ƒãƒ–ãƒ©ãƒ³ãƒã®PRã‚’æ‰¿èªã—ã€CDãƒ„ãƒ¼ãƒ«ã‚’åˆ©ç”¨ã—ãŸãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†ãŸã‚ã€‚ |
| GitHub App       | K8sãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆãƒªãƒã‚¸ãƒˆãƒª  | N/A      | é–‹ç™ºç’°å¢ƒãƒ–ãƒ©ãƒ³ãƒã¸ã® `push` ã‚„ã€æœ¬ç•ªç’°å¢ƒãƒ–ãƒ©ãƒ³ãƒã¸ã® PR ã‚’è¡Œã†ãŸã‚ã€‚ |

#### ArgoCDã®èªè¨¼ãƒ»èªå¯

ä»¥ä¸‹è¡¨ã®ã‚ˆã†ã«RBACè¨­è¨ˆã‚’å®šã‚ã‚‹ã€‚

| ã‚¢ã‚¯ã‚¿ãƒ¼          | å¯¾è±¡          | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | `project/object` | èª¬æ˜ãƒ»ç†ç”±                                                                         |
| :---------------- | :------------ | :--------- | :--------------- | :--------------------------------------------------------------------------------- |
| å…¨ã¦              | `*`           | `get`      | `*/*`            | å…¨ã¦ã®ã‚¢ã‚¯ã‚¿ãƒ¼ã«å¯¾ã—ã€å…¨ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹èª­ã¿å–ã‚Šè¨±å¯ã‚’ä¸ãˆã‚‹ãŸã‚[^argocd-read] |
| Operator          | `*`           | `admin`    | `*/*`            | é‹ç”¨ç®¡ç†ã®ãŸã‚ã€å…¨ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã«å¯¾ã™ã‚‹å…¨ã¦ã®è¨±å¯ã‚’ä¸ãˆã‚‹ãŸã‚                       |
| Developer(leader) | `application` | `sync`     | `dev/*`          | é–‹ç™ºè€…ã«é–‹ç™ºç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ¨©é™ã‚’ä¸ãˆã‚‹ãŸã‚                                       |
|                   | `application` | `exec`     | `dev/*`          | é–‹ç™ºè€…ã«é–‹ç™ºç’°å¢ƒPodã® `exec` æ¨©é™ã‚’ä¸ãˆã‚‹ãŸã‚[^argocd-exec]                        |

ä¸Šè¨˜ã‚’ã‚³ãƒ¼ãƒ‰åŒ–ã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚‹

```csv: policy.csv
g, ${github_org}:operator, role:operator
g, ${github_org}:developer, role:developer
g, ${github_org}:developer-leader, role:developer

g, role:operator, role:admin

p, role:developer, applications, sync, dev/*, allow
p, role:developer, exec, create, dev/*, allow
```

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒè·¯ (ãŠã¾ã‘)

æœ¬å°ç¯€ã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚’èª¬æ˜ã™ã‚‹ã€‚CICDè‡ªä½“ã¨ã¯é–¢ä¿‚ãªã„ãŸã‚ã€é£›ã°ã—ã¦è‰¯ã„ã€‚  
NginxIngress VitrualServer CRDè‡ªä½“ã¯[éå¸¸ã«è‰¯ã„è§£èª¬][thinkit-nginx-ingress]ãŒã‚ã‚‹ã€‚

ä»¥ä¸‹ã«æ¦‚è¦å›³ã‚’ç¤ºã™ã€‚ç‰¹æ®µç‰¹æ®Šãªã“ã¨ã¯ã—ã¦ã„ãªã„ã®ã§ã€èª¬æ˜ã¯çœç•¥ã™ã‚‹ã€‚
è¨­å®šæ„å›³ãªã©ã®æ€æƒ³ã¯[GitHubä¸Š][github-toyamagu-cicd-documents-design-internet-access]ã«ã¾ã¨ã‚ã¦ã„ã‚‹ã€‚èˆˆå‘³ãŒã‚ã‚Œã°å‚ç…§ã•ã‚ŒãŸã„ã€‚

![network](/images/cicd-eks-github-argocd/network.drawio.png)

### Terraform

æœ¬å°ç¯€ã¯Terraformåˆ©ç”¨æ–¹é‡ã‚’èª¬æ˜ã™ã‚‹ã€‚

#### Terraformæ¦‚è¦

æœ¬æ ¼çš„ã«ã‚¯ãƒ©ã‚¦ãƒ‰ã‚’åˆ©ç”¨ã—ã€å¤§é‡ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹å ´åˆã€Infrastructure as Code (IaC) ã¯äº‹å®Ÿä¸Šå¿…é ˆã§ã‚ã‚‹ã¨è¨€ã£ã¦ã‚ˆã„ã ã‚ã†ã€‚  
IaCã‚’æ´»ç”¨ã™ã‚‹ã“ã¨ã®ãƒ¡ãƒªãƒƒãƒˆã«ã¯æšæŒ™ã«æš‡ãŒãªã„ãŒã€ä¾‹ãˆã°ä»¥ä¸‹ãŒã‚ã‚‹ã€‚

- ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ï¼‰ãƒªã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ¼ãƒ‰åŒ–ã—ã€å®£è¨€çš„ã«ä½œæˆã§ãã‚‹
- ç’°å¢ƒã‚’ã™ãã«ç«‹ã¡ä¸Šã’ã€ä¸è¦ã«ãªã£ãŸã‚‰å»ƒæ£„ã§ãã‚‹
- ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ‰ãƒªãƒ•ãƒˆã‚’æ¤œå‡ºã—ã€GitOpsã«åŸºã¥ã„ãŸã‚ã‚‹ã¹ãå§¿ã‹ã‚‰ã¯ãšã‚ŒãŸå ´åˆã«æ¤œå‡ºã§ãã‚‹
- CICDã¨çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€ãƒ–ãƒ©ãƒ³ãƒä½œæˆã‚„PRã«ç´ã¥ã‘ãŸãƒªã‚½ãƒ¼ã‚¹ä½œæˆãªã©ã®å¿œç”¨ãŒã§ãã‚‹

AWSã§IaCã‚’è¡Œã†å ´åˆAWS CDKãƒ»CloudFormationãƒ»Terraformãƒ»Pulumiç­‰ã®é¸æŠè‚¢ãŒã‚ã‚‹ã€‚  
æœ¬æ–‡æ›¸ã§ã¯æ±ç”¨æ€§ãŒé«˜ãã€å®‰å®šçš„ã§ã€å¹…åºƒã„providerï¼ˆãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã§ãã‚‹ãƒªã‚½ãƒ¼ã‚¹ï¼‰ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã‚‹Terraformã‚’ç”¨ã„ã‚‹ã€‚
Terraformè‡ªä½“ã®CICDã¯æ¤œè¨¼ç›®çš„ã®ãŸã‚è¡Œã‚ãªã„ãŒã€æœ¬ç•ªç’°å¢ƒã§é‹ç”¨ã™ã‚‹å ´åˆã€Terraformã®CICDã‚‚ã§ãã¦ã„ã‚‹ã¨æœ›ã¾ã—ã„ã ã‚ã†[^atlantis]ã€‚  
ç‰¹ã«ã€CICDã‚’å®šæœŸçš„ã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°ã—ã¦ãŠã‘ã°ã€(ã•ã™ãŒã«å®Ÿéš›ã«Applyã¯ã—ãªã„ãŒ)ãƒ‰ãƒªãƒ•ãƒˆã®æ¤œå‡ºãŒã§ãã¦ã‚ˆã„ã€‚

#### Terraformåˆ©ç”¨æ–¹é‡

æœ¬æ–‡æ›¸ã§ã¯Terraformã§ç®¡ç†ã§ãã‚‹éƒ¨åˆ†ã¯å…¨ã¦ç®¡ç†ã™ã‚‹ã¨ã„ã†ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’å–ã‚‹ã€‚  
ã—ãŸãŒã£ã¦ã€ `terraform apply` ã‚³ãƒãƒ³ãƒ‰ã§ArgoCDã®ãƒªã‚½ãƒ¼ã‚¹ã‚‚å«ã‚ã¦å…¨ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã™ã€‚
Terraformã§ç®¡ç†ã™ã‚‹ãƒªã‚½ãƒ¼ã‚¹ã¯ä¾‹ãˆã°ä»¥ä¸‹ã§ã‚ã‚‹ã€‚

- EKSåŠã³VPC
- è³‡æ ¼æƒ…å ±
  - OAuth clientID, clientSecret
  - GitHub Appç§˜å¯†éµ
- K8sãƒªã‚½ãƒ¼ã‚¹
  - NS
  - ArgoCD
    - ApplicationSet
    - Project
    - Dexç”¨Secret
- GitHub
  - Organization/Team
  - ãƒªãƒã‚¸ãƒˆãƒª
    - ãƒ­ãƒ¼ãƒ«ä»˜ä¸
  - ãƒ–ãƒ©ãƒ³ãƒ (protection)

ä½•ã‚’ç®¡ç†ã—ãªã„ï¼ˆã§ããªã„ï¼‰ã‹ã‚’ä»¥ä¸‹ã«åˆ—æŒ™ã™ã‚‹ã€‚ç®¡ç†ã—ãªã„ç†ç”±ã¨ã—ã¦ã¯ã€å˜ç´”ã«[GitHub provider][terraform-provider-github]ãŒå¯¾å¿œã—ã¦ã„ãªã„ãŸã‚ã§ã‚ã‚‹ã€‚

- GitHub
  - User
  - Organization
  - OAuth Apps
  - GitHub Apps

#### Secretsç®¡ç†

Terraformã‚’ç”¨ã„ãŸSecretsç®¡ç†ã¯[ã“ã¡ã‚‰ã®ãƒ–ãƒ­ã‚°][handling-secrets-with-terraform]ã®3.ã‚’å‚è€ƒã«ã—ãŸã€‚  
ã™ãªã‚ã¡ã€ParameterStoreã«ä¿ç®¡ã™ã‚‹å ´æ‰€ã ã‘ä½œã£ã¦ãŠã„ã¦ã€Terraformã® `local_exec` æ©Ÿèƒ½ã§æ›¸ãæ›ãˆã‚‹ã¨ã„ã†ã‚„ã‚Šæ–¹ã§ã‚ã‚‹ã€‚
è‹¥å¹²å·¥å¤«ã—ãŸç‚¹ã¨ã—ã¦ã€è³‡æ ¼æƒ…å ±ãŒä¸ãˆã‚‰ã‚Œã¦ã„ã‚Œã°ParameterStoreã®æ›¸ãæ›ãˆã‚’è¡Œã„ã€ä¸ãˆã‚‰ã‚Œã¦ã„ãªã‘ã‚Œã°å€¤ã‚’dataã‚’ç”¨ã„ã¦æŒã£ã¦ãã‚‹ã¨ã„ã†å½¢ã«ã—ãŸã€‚

#### Terraformã‚³ãƒ¼ãƒ‰

å…¨ã¦ [`toyamagu-cicd/terraform-argocd-cicd`][terraform-argocd-cicd] ä»¥ä¸‹ã«æ ¼ç´ã—ã¦ã„ã‚‹ã€‚

- GitHubé–¢é€£
  - `resources/github`
- ArgoCDé–¢é€£
  - `resources/argocd`

ä¸Šè¨˜ã®Terraformã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚Šæœ¬æ–‡æ›¸ã§è¨˜è¿°ã•ã‚ŒãŸã»ã¨ã‚“ã©ã®ãƒªã‚½ãƒ¼ã‚¹ãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã€‚
æ‰‹é †ã®æ¦‚ç•¥ã¯ `README.md` ã«ã‚ã‚‹ã€‚

## ã¾ã¨ã‚

æœ¬æ–‡æ›¸ã§ã¯GitHub Actionsãƒ»ArgoCDã‚’CICDãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ç”¨ã„ã€EKSã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’è¡Œã†æ–¹æ³•ã‚’è¨˜è¼‰ã—ãŸã€‚  
è¨­å®šã¯æ¤œè¨¼ç”¨é€”ã®ãŸã‚ç²—ã„éƒ¨åˆ†ã‚‚å¤šã„ãŒã€æœ¬ç•ªç’°å¢ƒã§ã®é‹ç”¨ã‚‚è¦‹æ®ãˆã¦ã€æŠ‘ãˆã‚‹ã¹ããƒã‚¤ãƒ³ãƒˆã¯æŠ‘ãˆãŸã¤ã‚‚ã‚Šã§ã‚ã‚‹ã€‚  
ã¾ãŸã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã«è¿‘ã„éƒ¨åˆ†ã®ç®¡ç†ã¯å…¨ã¦Terraformã§å®£è¨€çš„ã«è¡Œã†ã¨ã„ã†æ€æƒ³ã®ã‚‚ã¨ã€æ¥µåŠ›Terraformã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã ã‘ã§å¿…è¦ãªãƒªã‚½ãƒ¼ã‚¹ãŒç«‹ã¡ä¸ŠãŒã‚‹ã‚ˆã†ã«ã—ãŸã€‚

é€”ä¸­åŠ›ä»˜ããŸéƒ¨åˆ†ã‚‚ã‚ã‚‹ã®ã§ã€èª¬æ˜ãŒå°‘ãªã„ãƒ»ã‚ã‚‹ã„ã¯èª¤ã£ã¦ã„ã‚‹éƒ¨åˆ†ãŒã‚ã‚Œã°ã€å–œã‚“ã§ä¿®æ­£ã—ãŸã„ã€‚æŒ‡æ‘˜ã‚’æ­“è¿ã—ã¾ã™ã€‚

æœ¬æ–‡æ›¸ãŒK8sé‹ç”¨ã®è‡ªå‹•åŒ–ã«å‘ã‘ã¦ã€ãªã«ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã‚ã‚‹ã€‚

## References

[^argocd-helm]: Terraformã§Kustomizeã‹Helmã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å ´åˆã€Helmã®ã»ã†ãŒæ¥½ã§ã‚ã‚‹ã€‚ãŸã ã—ã€ä»¥ä¸‹ç†ç”±ã‹ã‚‰ãƒ—ãƒ­ãƒ€ã‚¯ã‚·ãƒ§ãƒ³ã§ã®æ¡ç”¨ã¯æ…é‡ã«æ¤œè¨ã—ãŸæ–¹ãŒè‰¯ã„ã¨è€ƒãˆã‚‹ã€‚1) ArgoCD Helm chartã¯community maintainedã§ã‚ã‚‹ãŸã‚ã€å…¬å¼ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã¨æ¯”ã¹ã‚‹ã¨è‹¥å¹²ä¿¡é ¼æ€§ã«æ¬ ã‘ã‚‹é¢ãŒã‚ã‚‹ã€‚2) é »ç¹ã«ãƒªãƒªãƒ¼ã‚¹ãŒè¡Œã‚ã¦ã„ã‚‹ãŸã‚ã€è¿½å¾“ã™ã‚‹ã®ã¯è‹¥å¹²å¤§å¤‰ã€‚3) å…¬å¼ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚µãƒãƒ¼ãƒˆã¯N, N-1å‹ã ãŒã€helmãƒãƒ£ãƒ¼ãƒˆã®æ–¹ã¯æœ€æ–°ãƒã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¿ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã ã€‚å·¦è¨˜ã®å•é¡Œç‚¹ãŒã‚ã‚‹ãŸã‚ã€ã‚³ã‚¢ãªéƒ¨åˆ†ã®ã¿å…¬å¼ã®ãƒãƒ£ãƒ¼ãƒˆã‚’kustomizeã—ã€ApplicationSetãƒ»Applicationãƒ»Projectã®éƒ¨åˆ†ã®ã¿éƒ¨åˆ†çš„ã«argocd-appsãƒãƒ£ãƒ¼ãƒˆã‚’åˆ©ç”¨ã™ã‚‹ã®ã§ã‚‚ååˆ†ä¾¿åˆ©ã«åˆ©ç”¨ã§ãã‚‹ã¨æ€ã†ã€‚å€‹äººçš„ãªæ¤œè¨¼ç”¨é€”ã ãŒã€Kustomizeã‚’ç”¨ã„ãŸArgoCD ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« Terraform moduleä¾‹ã®[ãƒªãƒ³ã‚¯](https://github.com/toyamagu-2021/terraform-argocd-kustomize)ã‚’å¼µã£ã¦ãŠãã€‚
[^gitlab-flow]: å¿…è¦ã«å¿œã˜ã¦ãƒªãƒªãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‚„ã€ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒç”¨ã®ãƒ–ãƒ©ãƒ³ãƒã‚’è¿½åŠ ã™ã‚‹ã€‚
[^github-organization-free]: GitHubOrganizationFreeã§ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚°ãƒ«ãƒ¼ãƒ—æ¯ã®ç´°ã‹ã„æ¨©é™åˆ¶å¾¡ãŒã§ããªã„ãŸã‚ã€Enterpriseç‰ˆã«æ¯”ã¹ã¦ã ã„ã¶ç²—ã„ã‚‚ã®ã«ãªã‚‹ã€‚
[^k8s-manifest-push]: PRã§ã‚‚ã‚ˆã„ã€‚
[^cicd-checkout-k8s-manifest]: checkoutã—ã¦ã‹ã‚‰PRã™ã‚‹ã®ã¯ã€devãƒ–ãƒ©ãƒ³ãƒã®æ–­é¢ä¿ç®¡ã®ãŸã‚ã€‚
[^kustomize-branch]: ã‚‚ã¡ã‚ã‚“ã€å¿…è¦ã«å¿œã˜ã¦ç’°å¢ƒã”ã¨ã«ãƒ–ãƒ©ãƒ³ãƒåˆ†ã‘ã—ã¦ã‚‚ã‚ˆã„ã€‚
[^kustomize-directory]: [å…¬å¼](https://github.com/kubernetes-sigs/kustomize/blob/master/examples/helloWorld/README.md#compare-overlays)ã‚ˆã‚Šå¼•ç”¨ã—ãŸã€‚
[^governance]: å€‹äººçš„ãªæ„Ÿæƒ³ã ãŒã€CICDåŸºç›¤ã®æ¨©é™çµ±åˆ¶ã¯ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã¨å‘¼ã¶ã®ãŒå¥½ãã§ã‚ã‚‹ã€‚é–‹ç™ºã‚’è»Šã®èµ°è¡Œã«ä¾‹ãˆã‚‹ã¨ã€ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ã®å½¹å‰²ã¯ã‚€ã‚„ã¿ã«è»Šã®é€Ÿåº¦ã‚’æŠ‘ãˆã‚‹ãŸã‚ã«ã‚ã‚‹ã®ã§ã¯ãªã„ã€‚ä¸‡ãŒä¸€ã®ã“ã¨ãŒèµ·ã“ã‚Šãã†ã«ãªã£ã¦ã‚‚ã€è»Šã®æå‚·ã‚„äººçš„ãªè¢«å®³ã‚’æŠ‘ãˆã‚‹ãŸã‚ã«ã‚ã‚‹ï¼ˆã¨è§£é‡ˆã—ã¦ã„ã‚‹ï¼‰ã€‚
[^argocd-read]: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã® `read-only` ãƒ­ãƒ¼ãƒ«ã‚’ç”¨ã„ã‚‹ã€‚Podã®ãƒ­ã‚°ã«å¯¾ã™ã‚‹èª­ã¿å–ã‚Šæ¨©é™ã‚‚ä¸ãˆã¦ã—ã¾ã†ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯è¨±å®¹ã§ããªã„ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€æ¤œè¨ã™ã‚‹ã“ã¨ã€‚ArgoCD v2.4ä»¥é™ã§ã¯RBACã‚’ç”¨ã„ã¦ãƒ­ã‚°ã®é–²è¦§ã®ã¿ã‚’åˆ¶é™ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
[^argocd-exec]: `kubectl exec` ã¨ã»ã¼åŒã˜
[^argocd-project]: æ¨©é™çµ±åˆ¶ã®ä»–ã«ã‚‚ã€å®šæœŸçš„ãªãƒ‡ãƒ—ãƒ­ã‚¤ã‚„Orphaned resourceã®æ¤œå‡ºç­‰ã€æ§˜ã€…ãªæ©Ÿèƒ½ãŒã‚ã‚‹ã€‚æœ¬æ–‡æ›¸ã§ã¯æ¨©é™çµ±åˆ¶ä»¥å¤–ã®ç›®çš„ã«ã¯ç”¨ã„ãªã„ã€‚
[^argocd-applicationset-go-template]: [goTemplateæ©Ÿèƒ½](https://argo-cd.readthedocs.io/en/latest/operator-manual/applicationset/GoTemplate/)ãŒ v2.5ã‹ã‚‰å®Ÿè£…ã•ã‚Œã‚‹ã€‚ç¾åœ¨v2.5ã¯stableã§ãªã„ã®ã§æ³¨æ„ã€‚
[^argocd-app-of-apps]: App of Apps ãƒ‘ã‚¿ãƒ¼ãƒ³ã«é–¢ã™ã‚‹è«¸æ³¨æ„
    - App of Appsãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¯[å®Ÿè³ªçš„ã«å…¨ã¦ã®Projectã«ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã«ãªã£ã¦ã—ã¾ã†ãªã©ã®å•é¡ŒãŒã‚ã£ãŸ][argocd-issue-2785]ã€‚  
      ã“ã‚Œã¯v2.5ã‹ã‚‰ã®[Application in any namespaceæ©Ÿèƒ½][argocd-pr-application-in-any-namespace]ã§éƒ¨åˆ†çš„ã«è§£æ¶ˆã•ã‚Œã‚‹è¦‹è¾¼ã¿ã ãŒã€ä»¥ä¸‹ã®ç†ç”±ã‹ã‚‰æ¡ç”¨ã¯æ…é‡ã«æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
      - [Betaæ©Ÿèƒ½ã§ã‚ã‚‹][argocd-application-in-any-namespace]
      - ç¾æ™‚ç‚¹ã§ã¯ã‚¯ãƒ©ã‚¹ã‚¿å†…ã®ä»»æ„ã®NSã§ã®Applicationä½œæˆã‚’æƒ³å®šã—ã¦ãŠã‚Šã€ã‚¯ãƒ©ã‚¹ã‚¿é–“ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã‚‹ã‹ã¯æœªå®šã§ã‚ã‚‹
[^argocd-applicationset-git-generator]: ä»Šå›ã¯Git Generatorã®ä¸­ã§ã‚‚åŸºæœ¬çš„ãª[Directories][argocd-applicationset-directories]ã‚’ç”¨ã„ã‚‹ã€‚Gitãƒªãƒã‚¸ãƒˆãƒªã«è¨­ç½®ã—ãŸ config ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’æŒ‡å®šã™ã‚‹ãªã©ã‚‚ã§ãã‚‹ã€‚[Files][argocd-applicationset-files]ã‚’å‚ç…§ã€‚
[^argocd-applicationset-bootstrap]: Prometheusã‚„ã€ServiceMeshã€GateKeeperãªã©ã‚¤ãƒ³ãƒ•ãƒ©ã«è¿‘ã„ãƒªã‚½ãƒ¼ã‚¹ã¯bootstrapã«å«ã‚ã¦ã—ã¾ã„ãŸã„ã¨ã„ã†ãŠæ°—æŒã¡ã«ãªã‚‹ã€‚
[^atlantis]: TerraformCloudã‚’ã‚ˆãä½¿ã£ã¦ã„ã‚‹ãŒã€[atlantis][atlantis]ã‚‚é¢ç™½ãã†ã§ä½¿ã£ã¦ã¿ãŸã„ã¨ã„ã†ãŠæ°—æŒã¡ã¯ã‚ã‚‹ã€‚PRã‚’Mergeã—ãŸå¾Œã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã‚‹ã®ã¯ã—ã‚“ã©ã„ã€‚
[^argocd-apps]: v5.0.0ã‹ã‚‰ `argo-cd` Helm chartã‹ã‚‰åˆ†é›¢ã—ãŸã€‚ArgoCD CRDã‚’Helm chartå†…ã«å«ã‚ã‚‹éš›ã«ã€CRDã«ä¾å­˜ã—ã¦ã„ã‚‹éƒ¨åˆ†ãŒã‚ã‚‹ã¨è‰¯ããªã„ã¨ã„ã†ã“ã¨ã§å¤–ã ã—ã•ã‚ŒãŸã‚ˆã†ã§ã‚ã‚‹ã€‚èˆˆå‘³ãŒã‚ã‚‹äººã¯[PR][argo-helm-pr-manage-crd-by-helm]å‚ç…§ã®ã“ã¨ã€‚

[atlantis]: https://www.runatlantis.io/
[argocd-issue-2785]: https://github.com/argoproj/argo-cd/issues/2785
[eks]: https://aws.amazon.com/jp/eks/
[github-actions]: https://github.com/features/actions
[argocd]: https://argo-cd.readthedocs.io/en/stable/
[terraform-github-provider]: https://registry.terraform.io/providers/integrations/github/latest/docs
[terraform-eks-module]: https://registry.terraform.io/modules/terraform-aws-modules/eks/aws/latest
[terraform-helm-provider]: https://registry.terraform.io/providers/integrations/github/latest/docs
[argocd-helm]: https://github.com/argoproj/argo-helm
[toyamagu-cicd]: https://github.com/toyamagu-cicd
[argocd-best-practices]: https://argo-cd.readthedocs.io/en/stable/user-guide/best_practices/
[git-flow]: https://nvie.com/posts/a-successful-git-branching-model/
[github-flow]: https://docs.github.com/en/get-started/quickstart/github-flow
[gitlab-flow]: https://docs.gitlab.com/ee/topics/gitlab_flow.html
[trunc-base-flow]: https://www.atlassian.com/continuous-delivery/continuous-integration/trunk-based-development
[argo-cd]: https://argo-cd.readthedocs.io/en/stable/
[cncf-argocd]: https://www.cncf.io/projects/argo/
[github-argocd]: https://github.com/argoproj/argo-cd
[jenkins]: https://www.jenkins.io/
[spinnaker]: https://spinnaker.io/
[argo-rollout]: https://argoproj.github.io/argo-rollouts/
[argo-workflows]: https://argoproj.github.io/argo-workflows/
[kustomize]: https://kustomize.io/
[argocd-application-in-any-namespace]: https://argo-cd--10678.org.readthedocs.build/en/10678/operator-manual/app-any-namespace/
[monorepos]: https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Use-Cases/#use-case-monorepos
[argocd-applicationset-directories]: https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Generators-Git/#git-generator-directories
[argocd-applicationset-files]: https://argo-cd.readthedocs.io/en/stable/operator-manual/applicationset/Generators-Git/#git-generator-files
[argocd-user-management]: https://argo-cd.readthedocs.io/en/stable/operator-manual/user-management
[12factor-app-config]: https://12factor.net/config
[github-k8s-manifest-nginx-ingress]: https://github.com/toyamagu-cicd/argocd-cicd-k8s-manifest/tree/main/application/bootstrap/nginx-ingress
[github-k8s-manifest-virtual-server]: https://github.com/toyamagu-cicd/argocd-cicd-k8s-manifest/tree/main/application/bootstrap/virtual-server
[ingress-nginx]: https://github.com/kubernetes/ingress-nginx
[thinkit-nginx-ingress]: https://thinkit.co.jp/article/18771
[github-toyamagu-cicd-documents-design-internet-access]: https://github.com/toyamagu-cicd/document/blob/argocd-cicd/argocd-cicd/design.md#internet-access
[terraform]: https://www.terraform.io/
[zenn-github-app]: https://zenn.dev/tatsuo48/articles/72c8939bbc6329
[toyamagu-cicd-argocd-cicd-k8s-manifest]: https://github.com/toyamagu-cicd/argocd-cicd-k8s-manifest
[terraform-provider-github]: https://registry.terraform.io/providers/integrations/github/latest/docs
[sealed-secrets]: https://github.com/bitnami-labs/sealed-secrets
[vault]: https://www.vaultproject.io/
[external-secrets]: https://external-secrets.io/v0.6.0/
[secrets-store-csi-driver]: https://secrets-store-csi-driver.sigs.k8s.io/
[terraform-kubernetes-provider]: https://registry.terraform.io/providers/hashicorp/kubernetes/latest/docs
[secrets-store-csi-driver-aws]: https://docs.aws.amazon.com/secretsmanager/latest/userguide/integrating_csi_driver.html
[handling-secrets-with-terraform]: https://engineering.mobalab.net/2021/03/25/handling-secrets-with-terraform/
[toyamagu-cicd-argocd-cicd-application]: https://github.com/toyamagu-cicd/argocd-cicd-application/blob/main/.github/workflows/push.yaml
[configuring-openid-connect-in-amazon-web-services]: https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services
[zenn-github-actions-support-openid-connect]: https://zenn.dev/miyajan/articles/github-actions-support-openid-connect
[conftest]: https://www.conftest.dev/
[opa]: https://www.openpolicyagent.org/
[terraform-argocd-cicd]: https://github.com/toyamagu-cicd/terraform-argocd-cicd
[argo-helm]: https://github.com/argoproj/argo-helm
[argo-helm-pr-manage-crd-by-helm]: https://github.com/argoproj/argo-helm/pull/1342
[argocd-pr-application-in-any-namespace]: https://github.com/argoproj/argo-cd/pull/9755
